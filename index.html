<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é©—çœ¼è³‡æ–™ç®¡ç†ç³»çµ±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1a5f7a;
            --primary-light: #2d8bba;
            --primary-dark: #0d3d4d;
            --accent: #57c5b6;
            --accent-light: #a8e6cf;
            --bg: #f8fafa;
            --bg-card: #ffffff;
            --text: #1a1a2e;
            --text-light: #666;
            --border: #e0e8e8;
            --shadow: rgba(26, 95, 122, 0.08);
            --danger: #e74c3c;
            --success: #27ae60;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 16px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .header h1 {
            font-size: 1.3rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1::before {
            content: "ğŸ‘ï¸";
            font-size: 1.4rem;
        }

        .header-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            display: flex;
            box-shadow: 0 -2px 16px var(--shadow);
            z-index: 100;
            border-top: 1px solid var(--border);
        }

        .nav-item {
            flex: 1;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: none;
            color: var(--text-light);
            font-family: inherit;
            font-size: 0.75rem;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item:active {
            background: var(--bg);
        }

        .nav-icon {
            font-size: 1.5rem;
            display: block;
            margin-bottom: 4px;
        }

        /* Pages */
        .page {
            display: none;
            padding: 16px;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Customer Cards */
        .customer-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .customer-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.2s;
            border: 1px solid var(--border);
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .customer-card.selected {
            background: linear-gradient(135deg, rgba(26, 95, 122, 0.08) 0%, rgba(87, 197, 182, 0.08) 100%);
            border-color: var(--primary);
        }

        .customer-card-checkbox {
            flex-shrink: 0;
            margin-top: 4px;
        }

        .customer-card-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .customer-card-content {
            flex: 1;
            cursor: pointer;
        }

        .customer-card-content:active {
            opacity: 0.8;
        }

        .customer-name {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-name::before {
            content: "ğŸ”¢";
        }

        .customer-meta {
            font-size: 0.85rem;
            color: var(--text-light);
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .customer-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .badge-count {
            background: var(--accent-light);
            color: var(--primary-dark);
        }

        /* Selection Controls */
        .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text);
            user-select: none;
        }

        .select-all-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .btn-delete-selected {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--danger);
            color: white;
        }

        .btn-delete-selected:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-delete-selected:not(:disabled):active {
            transform: scale(0.95);
        }

        /* Upload Form */
        .form-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }

        .form-title {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
            background: var(--bg);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
        }

        /* Photo Upload */
        .photo-upload-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .photo-upload-item {
            aspect-ratio: 4/3;
            border: 2px dashed var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
            position: relative;
            overflow: hidden;
        }

        .photo-upload-item:active {
            border-color: var(--primary-light);
            background: white;
        }

        .photo-upload-item.has-photo {
            border-style: solid;
            border-color: var(--accent);
        }

        .photo-upload-item input {
            display: none;
        }

        .photo-upload-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .photo-upload-label {
            font-size: 0.75rem;
            color: var(--text-light);
            text-align: center;
            padding: 0 8px;
        }

        .photo-preview {
            position: absolute;
            inset: 0;
            object-fit: cover;
            width: 100%;
            height: 100%;
        }

        .photo-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* Lens Type Buttons */
        .lens-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .lens-type-btn {
            padding: 14px 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg);
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .lens-type-btn:active {
            transform: scale(0.98);
        }

        .lens-type-btn.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 2px 8px var(--shadow);
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Detail View */
        .detail-header {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }

        .detail-name {
            font-size: 1.4rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .detail-info {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .photo-section {
            margin-bottom: 16px;
        }

        .photo-section-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .photo-view {
            width: 100%;
            border-radius: 12px;
            box-shadow: 0 2px 12px var(--shadow);
            cursor: pointer;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--primary);
            font-size: 0.9rem;
            margin-bottom: 16px;
            cursor: pointer;
            padding: 8px 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1rem;
        }

        /* Search */
        .search-bar {
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1.5px solid var(--border);
            border-radius: 24px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-card) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E") 14px center no-repeat;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 2px 12px var(--shadow);
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        /* Modal for full image */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Settings */
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
        }

        .setting-desc {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        .setting-value {
            color: var(--primary);
            font-weight: 500;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 4px;
        }

        /* Date display */
        .date-badge {
            background: var(--bg);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 8px;
            display: inline-block;
        }

        /* Expiry warning */
        .expiry-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>é©—çœ¼è³‡æ–™ç®¡ç†</h1>
        <div class="header-subtitle">Eye Exam Data Management</div>
    </header>

    <!-- Home Page - Customer List -->
    <div id="page-home" class="page active">
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="æœå°‹å®¢äººç·¨è™Ÿæˆ–èˆŠè™Ÿç¢¼...">
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalCustomers">0</div>
                <div class="stat-label">ä»Šæ—¥å®¢äºº</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPhotos">0</div>
                <div class="stat-label">ç›¸ç‰‡æ•¸é‡</div>
            </div>
        </div>

        <div class="expiry-warning">
            âš ï¸ è³‡æ–™æœƒå–º 3 æ—¥å¾Œè‡ªå‹•æ¸…é™¤ï¼Œè«‹åŠæ™‚è™•ç†
        </div>

        <div class="selection-controls">
            <label class="select-all-container">
                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()">
                <span>å…¨é¸</span>
            </label>
            <button id="deleteSelectedBtn" class="btn-delete-selected" onclick="deleteSelected()" disabled>
                ğŸ—‘ï¸ åˆªé™¤é¸å–é …ç›® (<span id="selectedCount">0</span>)
            </button>
        </div>

        <div id="customerList" class="customer-list">
            <!-- Customer cards will be loaded here -->
        </div>
    </div>

    <!-- Upload Page -->
    <div id="page-upload" class="page">
        <div class="form-section">
            <div class="form-title">ğŸ“ å®¢äººè³‡æ–™</div>
            <div class="form-group">
                <label class="form-label">å®¢äººç·¨è™Ÿï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</label>
                <input type="text" class="form-input" id="customerNumber" readonly style="background: var(--bg); font-weight: 600; font-size: 1.2rem; color: var(--primary);">
            </div>
            <div class="form-group">
                <label class="form-label">å®¢äººèˆŠè™Ÿç¢¼</label>
                <input type="text" class="form-input" id="customerOldNumber" placeholder="è¼¸å…¥å®¢äººèˆŠè™Ÿç¢¼ï¼ˆå¦‚æœ‰ï¼‰">
            </div>
            <div class="form-group">
                <label class="form-label">é¡ç‰‡é¡å‹ *ï¼ˆå¯å¤šé¸ï¼‰</label>
                <div class="lens-type-grid">
                    <button type="button" class="lens-type-btn" data-type="é è¦–">ğŸ‘ï¸ ç‡é </button>
                    <button type="button" class="lens-type-btn" data-type="è¿‘è¦–">ğŸ“– ç‡è¿‘</button>
                    <button type="button" class="lens-type-btn" data-type="æ¼¸é€²">ğŸ”„ æ¼¸é€²</button>
                    <button type="button" class="lens-type-btn" data-type="å…¶ä»–">ğŸ“‹ å…¶ä»–</button>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="form-title">ğŸ“· ä¸Šè¼‰ç›¸ç‰‡</div>
            <div class="photo-upload-grid">
                <div class="photo-upload-item" data-type="old-glasses">
                    <input type="file" accept="image/*" capture="environment">
                    <span class="photo-upload-icon">ğŸ‘“</span>
                    <span class="photo-upload-label">èˆŠçœ¼é¡è³‡æ–™</span>
                </div>
                <div class="photo-upload-item" data-type="old-record-1">
                    <input type="file" accept="image/*" capture="environment">
                    <span class="photo-upload-icon">ğŸ“„</span>
                    <span class="photo-upload-label">èˆŠç´€éŒ„ 1</span>
                </div>
                <div class="photo-upload-item" data-type="old-record-2">
                    <input type="file" accept="image/*" capture="environment">
                    <span class="photo-upload-icon">ğŸ“„</span>
                    <span class="photo-upload-label">èˆŠç´€éŒ„ 2</span>
                </div>
                <div class="photo-upload-item" data-type="machine-data">
                    <input type="file" accept="image/*" capture="environment">
                    <span class="photo-upload-icon">ğŸ”¬</span>
                    <span class="photo-upload-label">åº¦æ•¸æ©Ÿè³‡æ–™</span>
                </div>
            </div>
        </div>

        <button class="btn btn-primary" id="submitBtn" disabled>
            å„²å­˜è³‡æ–™
        </button>
    </div>

    <!-- Customer Detail Page -->
    <div id="page-detail" class="page">
        <div class="back-btn" onclick="showPage('home')">
            â† è¿”å›åˆ—è¡¨
        </div>
        <div id="customerDetail">
            <!-- Detail content will be loaded here -->
        </div>
    </div>

    <!-- Settings Page -->
    <div id="page-settings" class="page">
        <div class="form-section">
            <div class="form-title">ğŸ”¥ Firebase ç‹€æ…‹</div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">é€£æ¥ç‹€æ…‹</div>
                    <div class="setting-desc">eye-exam-data-5c914.firebaseapp.com</div>
                </div>
                <span class="setting-value" id="firebaseStatus" style="color: var(--success);">å·²é€£æ¥ âœ“</span>
            </div>
        </div>

        <div class="form-section">
            <div class="form-title">ğŸ“Š è³‡æ–™çµ±è¨ˆ</div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">é›²ç«¯è³‡æ–™</div>
                    <div class="setting-desc">å„²å­˜å–º Firebase å˜…å®¢äººç´€éŒ„</div>
                </div>
                <span class="setting-value" id="cloudDataCount">è¼‰å…¥ä¸­...</span>
            </div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">æœ¬æ©Ÿæš«å­˜</div>
                    <div class="setting-desc">é›¢ç·šæ™‚å˜…æœ¬æ©Ÿå‚™ä»½</div>
                </div>
                <span class="setting-value" id="localDataCount">0 ç­†</span>
            </div>
        </div>

        <div class="form-section">
            <div class="form-title">ğŸ—‘ï¸ è³‡æ–™ç®¡ç†</div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">æ¸…é™¤æœ¬æ©Ÿæš«å­˜</div>
                    <div class="setting-desc">åˆªé™¤æœ¬æ©Ÿå‚™ä»½è³‡æ–™</div>
                </div>
                <button class="btn btn-danger" style="width: auto; padding: 8px 16px;" onclick="clearLocalData()">
                    æ¸…é™¤
                </button>
            </div>
        </div>

        <div class="form-section">
            <div class="form-title">â„¹ï¸ ä½¿ç”¨èªªæ˜</div>
            <ol style="padding-left: 20px; line-height: 1.8; font-size: 0.9rem; color: var(--text-light);">
                <li>å–ºã€Œä¸Šè¼‰ã€é é¢è¼¸å…¥å®¢äººè³‡æ–™</li>
                <li>å½±ç›¸ä¸Šè¼‰èˆŠçœ¼é¡ã€èˆŠç´€éŒ„åŒåº¦æ•¸æ©Ÿè³‡æ–™</li>
                <li>å–ºã€Œé¦–é ã€å¯ä»¥æœå°‹åŒæŸ¥çœ‹æ‰€æœ‰å®¢äºº</li>
                <li>é»æ“Šå®¢äººå¡ç‰‡æŸ¥çœ‹è©³ç´°è³‡æ–™</li>
                <li>è³‡æ–™æœƒè‡ªå‹•å–º 3 æ—¥å¾Œæ¸…é™¤</li>
            </ol>
        </div>

        <div class="form-section">
            <div class="form-title">ğŸ”§ Firebase è¦å‰‡è¨­å®š</div>
            <div style="font-size: 0.85rem; color: var(--text-light); line-height: 1.6;">
                <p style="margin-bottom: 8px;"><strong>Firestore Database è¦å‰‡ï¼š</strong></p>
                <code style="display: block; background: var(--bg); padding: 10px; border-radius: 6px; font-size: 0.75rem; margin-bottom: 12px; white-space: pre-wrap;">rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}</code>
                <p style="margin-bottom: 8px;"><strong>Storage è¦å‰‡ï¼š</strong></p>
                <code style="display: block; background: var(--bg); padding: 10px; border-radius: 6px; font-size: 0.75rem; white-space: pre-wrap;">rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if true;
    }
  }
}</code>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <nav class="nav">
        <button class="nav-item active" onclick="showPage('home')">
            <span class="nav-icon">ğŸ </span>
            é¦–é 
        </button>
        <button class="nav-item" onclick="showPage('upload')">
            <span class="nav-icon">â•</span>
            ä¸Šè¼‰
        </button>
        <button class="nav-item" onclick="showPage('settings')">
            <span class="nav-icon">âš™ï¸</span>
            è¨­å®š
        </button>
    </nav>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Image Modal -->
    <div id="imageModal" class="modal" onclick="closeModal()">
        <button class="modal-close">Ã—</button>
        <img id="modalImage" src="" alt="">
    </div>

    <!-- Firebase SDK - Alternative CDN -->
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-firestore-compat.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/firebase@9.22.0/firebase-storage-compat.min.js"></script>

    <script>
        // ============ State Management ============
        let db = null;
        let storage = null;
        let firebaseInitialized = false;
        let selectedLensTypes = []; // Changed to array for multiple selection
        
        const uploadedPhotos = {
            'old-glasses': null,
            'old-record-1': null,
            'old-record-2': null,
            'machine-data': null
        };

        // Selection state
        let selectedCustomers = new Set();

        // ============ Customer Number Generator ============
        function generateCustomerNumber() {
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
            const timeStr = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            const random = String(Math.floor(Math.random() * 100)).padStart(2, '0');
            return `${dateStr}-${timeStr}-${random}`;
        }

        // ============ Local Storage (Fallback) ============
        const LOCAL_STORAGE_KEY = 'eyeExamData';
        const EXPIRY_DAYS = 3;

        function getLocalData() {
            const data = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (!data) return [];
            
            const records = JSON.parse(data);
            const now = Date.now();
            const validRecords = records.filter(r => {
                const expiryTime = r.createdAt + (EXPIRY_DAYS * 24 * 60 * 60 * 1000);
                return now < expiryTime;
            });
            
            if (validRecords.length !== records.length) {
                saveLocalData(validRecords);
            }
            
            return validRecords;
        }

        function saveLocalData(data) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
        }

        function addLocalRecord(record) {
            const data = getLocalData();
            record.id = 'local_' + Date.now();
            record.createdAt = Date.now();
            data.unshift(record);
            saveLocalData(data);
            return record;
        }

        function deleteLocalRecord(id) {
            const data = getLocalData();
            const filtered = data.filter(r => r.id !== id);
            saveLocalData(filtered);
        }

        // ============ Firebase Setup ============
        function initFirebase() {
            // Check if Firebase SDK is loaded
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                showToast('Firebase è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬æ©Ÿå„²å­˜', 'error');
                return false;
            }

            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyC3yU01v_fOhBiwXuQPzQtlQdGaHHnGTVw",
                    authDomain: "eye-exam-data-5c914.firebaseapp.com",
                    projectId: "eye-exam-data-5c914",
                    storageBucket: "eye-exam-data-5c914.firebasestorage.app",
                    messagingSenderId: "716742721009",
                    appId: "1:716742721009:web:ba7388feed77700a2d5850"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                storage = firebase.storage();
                firebaseInitialized = true;
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.error('Firebase init error:', error);
                showToast('Firebase é€£æ¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬æ©Ÿå„²å­˜', 'error');
                return false;
            }
        }

        // ============ Data Operations ============
        async function saveCustomer(customerData) {
            // Check if Firebase is available
            if (!firebaseInitialized || !db || !storage) {
                console.log('Firebase not available, saving locally');
                showToast('ä½¿ç”¨æœ¬æ©Ÿå„²å­˜', '');
                return addLocalRecord(customerData);
            }

            try {
                // Upload photos to Firebase Storage with timeout
                const photoUrls = {};
                for (const [type, data] of Object.entries(customerData.photos)) {
                    if (data) {
                        try {
                            const fileName = `photos/${Date.now()}_${Math.random().toString(36).substring(2, 11)}_${type}.jpg`;
                            const ref = storage.ref().child(fileName);
                            console.log('Uploading:', fileName);
                            
                            // Upload with metadata
                            const metadata = { contentType: 'image/jpeg' };
                            await ref.putString(data, 'data_url', metadata);
                            photoUrls[type] = await ref.getDownloadURL();
                            console.log('Upload success:', type);
                        } catch (uploadError) {
                            console.error('Photo upload error:', type, uploadError);
                            // Store base64 directly if upload fails
                            photoUrls[type] = data;
                        }
                    }
                }

                // Save to Firestore
                const docData = {
                    number: customerData.number,
                    oldNumber: customerData.oldNumber || '',
                    lensTypes: customerData.lensTypes || [],
                    photos: photoUrls,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    expiresAt: new Date(Date.now() + EXPIRY_DAYS * 24 * 60 * 60 * 1000)
                };
                
                console.log('Saving to Firestore...');
                const docRef = await db.collection('customers').add(docData);
                console.log('Saved with ID:', docRef.id);

                return { id: docRef.id, ...customerData, photos: photoUrls };
            } catch (error) {
                console.error('Firebase save error:', error);
                showToast('é›²ç«¯å„²å­˜å¤±æ•—ï¼Œå·²å­˜åˆ°æœ¬æ©Ÿ', 'error');
                return addLocalRecord(customerData);
            }
        }

        async function updateCustomer(id, customerData) {
            // Handle local records
            if (id.startsWith('local_')) {
                const data = getLocalData();
                const index = data.findIndex(r => r.id === id);
                if (index !== -1) {
                    // Keep the original ID and createdAt
                    data[index] = {
                        ...data[index],
                        number: customerData.number,
                        oldNumber: customerData.oldNumber,
                        lensTypes: customerData.lensTypes,
                        photos: customerData.photos
                    };
                    saveLocalData(data);
                    return data[index];
                }
                throw new Error('æ‰¾ä¸åˆ°æœ¬æ©Ÿç´€éŒ„');
            }

            // Handle Firebase records
            if (!firebaseInitialized || !db || !storage) {
                throw new Error('Firebase æœªé€£æ¥');
            }

            try {
                // Upload new photos to Firebase Storage
                const photoUrls = {};
                for (const [type, data] of Object.entries(customerData.photos)) {
                    if (data) {
                        // Check if it's a new upload (base64) or existing URL
                        if (data.startsWith('data:')) {
                            try {
                                const fileName = `photos/${Date.now()}_${Math.random().toString(36).substring(2, 11)}_${type}.jpg`;
                                const ref = storage.ref().child(fileName);
                                const metadata = { contentType: 'image/jpeg' };
                                await ref.putString(data, 'data_url', metadata);
                                photoUrls[type] = await ref.getDownloadURL();
                            } catch (uploadError) {
                                console.error('Photo upload error:', type, uploadError);
                                photoUrls[type] = data;
                            }
                        } else {
                            // Keep existing URL
                            photoUrls[type] = data;
                        }
                    }
                }

                // Update Firestore document
                const docData = {
                    number: customerData.number,
                    oldNumber: customerData.oldNumber || '',
                    lensTypes: customerData.lensTypes || [],
                    photos: photoUrls,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('customers').doc(id).update(docData);
                return { id, ...customerData, photos: photoUrls };
            } catch (error) {
                console.error('Firebase update error:', error);
                throw error;
            }
        }

        async function loadCustomers() {
            let customers = [];

            // Load local data first
            customers = getLocalData();

            // Try to load from Firebase
            if (firebaseInitialized && db) {
                try {
                    const snapshot = await db.collection('customers')
                        .orderBy('createdAt', 'desc')
                        .get();

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        customers.push({
                            id: doc.id,
                            ...data,
                            createdAt: data.createdAt?.toMillis() || Date.now(),
                            source: 'firebase'
                        });
                    });
                } catch (error) {
                    console.error('Firebase load error:', error);
                }
            }

            // Sort by creation date (newest first)
            customers.sort((a, b) => b.createdAt - a.createdAt);
            
            return customers;
        }

        async function deleteCustomer(id) {
            if (id.startsWith('local_')) {
                deleteLocalRecord(id);
            } else if (firebaseInitialized && db) {
                try {
                    await db.collection('customers').doc(id).delete();
                } catch (error) {
                    console.error('Delete error:', error);
                }
            }
        }

        // ============ Selection Functions ============
        function toggleCustomerSelection(id, event) {
            event.stopPropagation(); // Prevent card click
            
            if (selectedCustomers.has(id)) {
                selectedCustomers.delete(id);
            } else {
                selectedCustomers.add(id);
            }
            
            updateSelectionUI();
        }

        function toggleSelectAll() {
            const checkbox = document.getElementById('selectAllCheckbox');
            const customerCards = document.querySelectorAll('.customer-card-checkbox input[type="checkbox"]');
            
            selectedCustomers.clear();
            
            if (checkbox.checked) {
                customerCards.forEach(cb => {
                    selectedCustomers.add(cb.value);
                    cb.checked = true;
                });
            } else {
                customerCards.forEach(cb => {
                    cb.checked = false;
                });
            }
            
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const selectedCount = selectedCustomers.size;
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const customerCheckboxes = document.querySelectorAll('.customer-card-checkbox input[type="checkbox"]');
            
            // Update selected count
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // Enable/disable delete button
            deleteBtn.disabled = selectedCount === 0;
            
            // Update select all checkbox state
            const totalCheckboxes = customerCheckboxes.length;
            if (selectedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCount === totalCheckboxes) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            // Update card styling and checkbox states
            customerCheckboxes.forEach(cb => {
                const card = cb.closest('.customer-card');
                const isSelected = selectedCustomers.has(cb.value);
                cb.checked = isSelected;
                
                if (isSelected) {
                    card.classList.add('selected');
                } else {
                    card.classList.remove('selected');
                }
            });
        }

        async function deleteSelected() {
            if (selectedCustomers.size === 0) return;
            
            const count = selectedCustomers.size;
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${count} å€‹å®¢äººç´€éŒ„ï¼Ÿ`)) {
                return;
            }
            
            // Delete all selected customers
            const deletePromises = Array.from(selectedCustomers).map(id => deleteCustomer(id));
            await Promise.all(deletePromises);
            
            // Clear selection
            selectedCustomers.clear();
            
            // Refresh the list
            await refreshCustomerList();
            
            showToast(`å·²åˆªé™¤ ${count} å€‹ç´€éŒ„`, 'success');
        }

        // ============ UI Functions ============
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelectorAll('.nav-item')[
                pageName === 'home' ? 0 : pageName === 'upload' ? 1 : 2
            ].classList.add('active');

            if (pageName === 'home') {
                // Clear selections when returning to home page
                selectedCustomers.clear();
                refreshCustomerList();
            } else if (pageName === 'upload') {
                // Generate new customer number if form is empty
                if (selectedLensTypes.length === 0 && !Object.values(uploadedPhotos).some(p => p)) {
                    document.getElementById('customerNumber').value = generateCustomerNumber();
                }
            } else if (pageName === 'settings') {
                updateSettingsUI().catch(console.error);
            }
        }

        async function refreshCustomerList() {
            const listEl = document.getElementById('customerList');
            listEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const customers = await loadCustomers();
            
            // Update stats
            document.getElementById('totalCustomers').textContent = customers.length;
            let photoCount = 0;
            customers.forEach(c => {
                photoCount += Object.values(c.photos || {}).filter(p => p).length;
            });
            document.getElementById('totalPhotos').textContent = photoCount;

            if (customers.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div class="empty-state-text">æœªæœ‰å®¢äººè³‡æ–™<br>é»æ“Šã€Œä¸Šè¼‰ã€æ–°å¢</div>
                    </div>
                `;
                return;
            }

            const lensTypeIcons = {
                'é è¦–': 'ğŸ‘ï¸',
                'è¿‘è¦–': 'ğŸ“–',
                'æ¼¸é€²': 'ğŸ”„',
                'å…¶ä»–': 'ğŸ“‹'
            };

            listEl.innerHTML = customers.map(c => {
                const photoCount = Object.values(c.photos || {}).filter(p => p).length;
                const date = new Date(c.createdAt);
                const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                // Handle both old single lensType and new lensTypes array
                const types = c.lensTypes || (c.lensType ? [c.lensType] : []);
                const lensDisplay = types.map(t => `${lensTypeIcons[t] || 'ğŸ“‹'} ${t}`).join(' Â· ') || 'æœªé¸æ“‡';
                
                return `
                    <div class="customer-card ${selectedCustomers.has(c.id) ? 'selected' : ''}">
                        <div class="customer-card-checkbox">
                            <input type="checkbox" value="${c.id}" 
                                ${selectedCustomers.has(c.id) ? 'checked' : ''}
                                onchange="toggleCustomerSelection('${c.id}', event)">
                        </div>
                        <div class="customer-card-content" onclick="showCustomerDetail('${c.id}')">
                            <div class="customer-name">${escapeHtml(c.number || 'æœªæœ‰ç·¨è™Ÿ')}</div>
                            <div class="customer-meta">
                                <span>${lensDisplay}</span>
                                ${c.oldNumber ? `<span>ğŸ“ èˆŠè™Ÿ: ${escapeHtml(c.oldNumber)}</span>` : ''}
                                <span><span class="badge badge-count">${photoCount} å¼µç›¸ç‰‡</span></span>
                            </div>
                            <div class="date-badge">ğŸ• ${dateStr}</div>
                        </div>
                    </div>

                `;
            }).join('');
            
            // Update selection UI after rendering
            updateSelectionUI();
        }

        async function showCustomerDetail(id) {
            showPage('detail');
            const detailEl = document.getElementById('customerDetail');
            detailEl.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            const customers = await loadCustomers();
            const customer = customers.find(c => c.id === id);

            if (!customer) {
                detailEl.innerHTML = '<div class="empty-state">æ‰¾ä¸åˆ°å®¢äººè³‡æ–™</div>';
                return;
            }

            const date = new Date(customer.createdAt);
            const dateStr = `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

            const lensTypeLabels = {
                'é è¦–': 'ğŸ‘ï¸ ç‡é ',
                'è¿‘è¦–': 'ğŸ“– ç‡è¿‘',
                'æ¼¸é€²': 'ğŸ”„ æ¼¸é€²',
                'å…¶ä»–': 'ğŸ“‹ å…¶ä»–'
            };

            // Handle both old single lensType and new lensTypes array
            const types = customer.lensTypes || (customer.lensType ? [customer.lensType] : []);
            const lensTypeBadges = types.map(t => 
                `<span class="badge badge-count" style="font-size: 0.9rem; padding: 4px 12px; margin-right: 6px;">${lensTypeLabels[t] || t}</span>`
            ).join('') || '<span class="badge badge-count">æœªé¸æ“‡</span>';

            const photoLabels = {
                'old-glasses': 'ğŸ‘“ èˆŠçœ¼é¡è³‡æ–™',
                'old-record-1': 'ğŸ“„ èˆŠç´€éŒ„ 1',
                'old-record-2': 'ğŸ“„ èˆŠç´€éŒ„ 2',
                'machine-data': 'ğŸ”¬ åº¦æ•¸æ©Ÿè³‡æ–™'
            };

            let photosHtml = '';
            for (const [type, url] of Object.entries(customer.photos || {})) {
                if (url) {
                    photosHtml += `
                        <div class="photo-section">
                            <div class="photo-section-title">${photoLabels[type] || type}</div>
                            <img class="photo-view" src="${url}" alt="${type}" onclick="showImageModal('${url}')">
                        </div>
                    `;
                }
            }

            detailEl.innerHTML = `
                <div class="detail-header">
                    <div class="detail-name">ğŸ”¢ ${escapeHtml(customer.number || 'æœªæœ‰ç·¨è™Ÿ')}</div>
                    <div class="detail-info">
                        <div style="margin-bottom: 8px;">
                            ${lensTypeBadges}
                        </div>
                        ${customer.oldNumber ? `<div>ğŸ“ å®¢äººèˆŠè™Ÿç¢¼ï¼š${escapeHtml(customer.oldNumber)}</div>` : ''}
                        <div class="date-badge">å»ºç«‹æ™‚é–“ï¼š${dateStr}</div>
                    </div>
                </div>
                ${photosHtml || '<div class="empty-state">æœªæœ‰ç›¸ç‰‡</div>'}
                <button class="btn btn-primary" onclick="editCustomer('${id}')" style="margin-top: 20px;">
                    âœï¸ ç·¨è¼¯æ­¤ç´€éŒ„
                </button>
                <button class="btn btn-danger" onclick="confirmDelete('${id}')" style="margin-top: 12px;">
                    ğŸ—‘ï¸ åˆªé™¤æ­¤ç´€éŒ„
                </button>
            `;
        }

        function confirmDelete(id) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢äººç´€éŒ„ï¼Ÿ')) {
                deleteCustomer(id);
                showToast('å·²åˆªé™¤ç´€éŒ„', 'success');
                showPage('home');
            }
        }

        async function editCustomer(id) {
            const customers = await loadCustomers();
            const customer = customers.find(c => c.id === id);
            
            if (!customer) {
                showToast('æ‰¾ä¸åˆ°å®¢äººè³‡æ–™', 'error');
                return;
            }
            
            // Store the ID being edited
            window.editingCustomerId = id;
            
            // Switch to upload page
            showPage('upload');
            
            // Populate the form with existing data
            document.getElementById('customerNumber').value = customer.number || '';
            document.getElementById('customerOldNumber').value = customer.oldNumber || '';
            
            // Set lens types
            selectedLensTypes = [...(customer.lensTypes || [])];
            document.querySelectorAll('.lens-type-btn').forEach(btn => {
                const type = btn.dataset.type;
                if (selectedLensTypes.includes(type)) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            // Set photos
            Object.keys(uploadedPhotos).forEach(key => {
                uploadedPhotos[key] = customer.photos?.[key] || null;
            });
            
            // Update photo previews
            document.querySelectorAll('.photo-upload-item').forEach(item => {
                const type = item.dataset.type;
                updatePhotoPreview(item, uploadedPhotos[type]);
            });
            
            // Update submit button text and state
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.textContent = 'æ›´æ–°è³‡æ–™';
            updateSubmitButton();
            
            showToast('ç·¨è¼¯æ¨¡å¼', 'success');
        }

        function showImageModal(url) {
            document.getElementById('modalImage').src = url;
            document.getElementById('imageModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('show');
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show ' + type;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // ============ Photo Upload Handling ============
        /**
         * Compress an image to 1/4 of its original size
         * The compression reduces both width and height by half (resulting in 1/4 total area)
         * @param {File} file - The image file to compress
         * @param {number} quality - JPEG quality (0-1), default 0.5 for 50% quality
         * @returns {Promise<string>} - Base64 encoded compressed image data URL
         */
        async function compressImage(file, quality = 0.5) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        // Calculate new dimensions (1/4 size means 1/2 of width and height)
                        const canvas = document.createElement('canvas');
                        const targetWidth = img.width / 2;
                        const targetHeight = img.height / 2;
                        
                        canvas.width = targetWidth;
                        canvas.height = targetHeight;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        
                        // Convert to base64 with compression
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedDataUrl);
                    };
                    img.onerror = reject;
                    img.src = event.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function setupPhotoUploads() {
            document.querySelectorAll('.photo-upload-item').forEach(item => {
                const input = item.querySelector('input');
                const type = item.dataset.type;

                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('photo-remove')) return;
                    input.click();
                });

                input.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            // Compress the image to 1/4 size
                            const compressedDataUrl = await compressImage(file);
                            uploadedPhotos[type] = compressedDataUrl;
                            updatePhotoPreview(item, compressedDataUrl);
                            updateSubmitButton();
                        } catch (error) {
                            console.error('Image compression error:', error);
                            showToast('åœ–ç‰‡è™•ç†å¤±æ•—', 'error');
                        }
                    }
                });
            });
        }

        function updatePhotoPreview(item, dataUrl) {
            // Remove existing preview
            const existingPreview = item.querySelector('.photo-preview');
            const existingRemove = item.querySelector('.photo-remove');
            if (existingPreview) existingPreview.remove();
            if (existingRemove) existingRemove.remove();

            if (dataUrl) {
                item.classList.add('has-photo');
                
                const img = document.createElement('img');
                img.className = 'photo-preview';
                img.src = dataUrl;
                item.appendChild(img);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'photo-remove';
                removeBtn.innerHTML = 'Ã—';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    uploadedPhotos[item.dataset.type] = null;
                    item.classList.remove('has-photo');
                    img.remove();
                    removeBtn.remove();
                    item.querySelector('input').value = '';
                    updateSubmitButton();
                };
                item.appendChild(removeBtn);
            } else {
                item.classList.remove('has-photo');
            }
        }

        function updateSubmitButton() {
            const hasLensType = selectedLensTypes.length > 0;
            const hasPhoto = Object.values(uploadedPhotos).some(p => p);
            document.getElementById('submitBtn').disabled = !hasLensType || !hasPhoto;
        }

        function resetUploadForm() {
            // Clear editing mode
            window.editingCustomerId = null;
            
            // Generate new customer number
            document.getElementById('customerNumber').value = generateCustomerNumber();
            document.getElementById('customerOldNumber').value = '';
            
            // Reset lens type selection
            selectedLensTypes = [];
            document.querySelectorAll('.lens-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Reset photos
            Object.keys(uploadedPhotos).forEach(key => {
                uploadedPhotos[key] = null;
            });
            
            document.querySelectorAll('.photo-upload-item').forEach(item => {
                item.classList.remove('has-photo');
                const preview = item.querySelector('.photo-preview');
                const remove = item.querySelector('.photo-remove');
                if (preview) preview.remove();
                if (remove) remove.remove();
                item.querySelector('input').value = '';
            });
            
            // Reset submit button text
            document.getElementById('submitBtn').textContent = 'å„²å­˜è³‡æ–™';
            
            updateSubmitButton();
        }

        // ============ Settings ============
        async function updateSettingsUI() {
            document.getElementById('localDataCount').textContent = getLocalData().length + ' ç­†';
            
            // Update Firebase status
            const statusEl = document.getElementById('firebaseStatus');
            const cloudCountEl = document.getElementById('cloudDataCount');
            
            if (typeof firebase === 'undefined') {
                statusEl.textContent = 'SDK æœªè¼‰å…¥ âœ—';
                statusEl.style.color = 'var(--danger)';
                cloudCountEl.textContent = 'æœªé€£æ¥';
                return;
            }
            
            if (firebaseInitialized && db) {
                statusEl.textContent = 'å·²é€£æ¥ âœ“';
                statusEl.style.color = 'var(--success)';
                
                // Count cloud data
                try {
                    const snapshot = await db.collection('customers')
                        .where('expiresAt', '>', new Date())
                        .get();
                    cloudCountEl.textContent = snapshot.size + ' ç­†';
                } catch (error) {
                    console.error('Firestore read error:', error);
                    cloudCountEl.textContent = 'è®€å–å¤±æ•— - è«‹æª¢æŸ¥ Firestore è¦å‰‡';
                    statusEl.textContent = 'é€£æ¥ä½†ç„¡æ³•è®€å– âš ï¸';
                    statusEl.style.color = '#f39c12';
                }
            } else {
                statusEl.textContent = 'æœªé€£æ¥ âœ—';
                statusEl.style.color = 'var(--danger)';
                cloudCountEl.textContent = 'æœªé€£æ¥';
            }
        }

        function clearLocalData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æœ¬æ©Ÿæš«å­˜è³‡æ–™ï¼Ÿ')) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                showToast('å·²æ¸…é™¤æœ¬æ©Ÿè³‡æ–™', 'success');
                updateSettingsUI();
                refreshCustomerList();
            }
        }

        // ============ Search ============
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', async (e) => {
                const query = e.target.value.toLowerCase().trim();
                const customers = await loadCustomers();
                const listEl = document.getElementById('customerList');

                const filtered = query ? customers.filter(c => {
                    const types = c.lensTypes || (c.lensType ? [c.lensType] : []);
                    return (c.number && c.number.toLowerCase().includes(query)) || 
                           (c.oldNumber && c.oldNumber.toLowerCase().includes(query)) ||
                           types.some(t => t.includes(query));
                }) : customers;

                if (filtered.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ”</div>
                            <div class="empty-state-text">æ‰¾ä¸åˆ°ã€Œ${escapeHtml(query)}ã€</div>
                        </div>
                    `;
                    return;
                }

                const lensTypeIcons = {
                    'é è¦–': 'ğŸ‘ï¸',
                    'è¿‘è¦–': 'ğŸ“–',
                    'æ¼¸é€²': 'ğŸ”„',
                    'å…¶ä»–': 'ğŸ“‹'
                };

                listEl.innerHTML = filtered.map(c => {
                    const photoCount = Object.values(c.photos || {}).filter(p => p).length;
                    const date = new Date(c.createdAt);
                    const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    const types = c.lensTypes || (c.lensType ? [c.lensType] : []);
                    const lensDisplay = types.map(t => `${lensTypeIcons[t] || 'ğŸ“‹'} ${t}`).join(' Â· ') || 'æœªé¸æ“‡';
                    
                    return `
                        <div class="customer-card" onclick="showCustomerDetail('${c.id}')">
                            <div class="customer-name">${escapeHtml(c.number || 'æœªæœ‰ç·¨è™Ÿ')}</div>
                            <div class="customer-meta">
                                <span>${lensDisplay}</span>
                                ${c.oldNumber ? `<span>ğŸ“ èˆŠè™Ÿ: ${escapeHtml(c.oldNumber)}</span>` : ''}
                                <span><span class="badge badge-count">${photoCount} å¼µç›¸ç‰‡</span></span>
                            </div>
                            <div class="date-badge">ğŸ• ${dateStr}</div>
                        </div>
                    `;
                }).join('');
            });
        }

        // ============ Submit Handler ============
        async function handleSubmit() {
            const submitBtn = document.getElementById('submitBtn');
            const isEditing = !!window.editingCustomerId;
            
            submitBtn.disabled = true;
            submitBtn.textContent = isEditing ? 'æ›´æ–°ä¸­...' : 'å„²å­˜ä¸­...';

            try {
                const customerData = {
                    number: document.getElementById('customerNumber').value,
                    oldNumber: document.getElementById('customerOldNumber').value.trim(),
                    lensTypes: [...selectedLensTypes],
                    photos: { ...uploadedPhotos }
                };

                // Add timeout to prevent infinite loading
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('å„²å­˜è¶…æ™‚')), 30000)
                );
                
                let savePromise;
                if (isEditing) {
                    // Update existing customer
                    savePromise = updateCustomer(window.editingCustomerId, customerData);
                } else {
                    // Create new customer
                    savePromise = saveCustomer(customerData);
                }
                
                await Promise.race([savePromise, timeoutPromise]);
                
                showToast(isEditing ? 'âœ“ è³‡æ–™å·²æ›´æ–°' : 'âœ“ è³‡æ–™å·²å„²å­˜', 'success');
                
                // Clear editing mode
                window.editingCustomerId = null;
                
                resetUploadForm();
                showPage('home');
            } catch (error) {
                console.error('Submit error:', error);
                showToast('å„²å­˜å¤±æ•—: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'å„²å­˜è³‡æ–™';
            }
        }

        // ============ Initialize ============
        function initApp() {
            const firebaseOk = initFirebase();
            setupPhotoUploads();
            setupSearch();
            
            // Setup lens type buttons (multi-select toggle)
            document.querySelectorAll('.lens-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    const index = selectedLensTypes.indexOf(type);
                    
                    if (index > -1) {
                        selectedLensTypes.splice(index, 1);
                        btn.classList.remove('selected');
                    } else {
                        selectedLensTypes.push(type);
                        btn.classList.add('selected');
                    }
                    
                    updateSubmitButton();
                });
            });
            
            document.getElementById('submitBtn').addEventListener('click', handleSubmit);
            document.getElementById('customerNumber').value = generateCustomerNumber();
            
            refreshCustomerList();
            
            // Show status
            if (firebaseOk) {
                console.log('App initialized with Firebase');
            } else {
                console.log('App initialized with Local Storage only');
            }
        }

        // Wait for DOM and try to init
        document.addEventListener('DOMContentLoaded', () => {
            // Try immediately
            if (typeof firebase !== 'undefined') {
                initApp();
            } else {
                // Retry up to 3 times
                let retries = 0;
                const maxRetries = 3;
                const retryInterval = setInterval(() => {
                    retries++;
                    console.log('Checking Firebase SDK... attempt', retries);
                    if (typeof firebase !== 'undefined') {
                        clearInterval(retryInterval);
                        initApp();
                    } else if (retries >= maxRetries) {
                        clearInterval(retryInterval);
                        console.log('Firebase SDK not available, using local storage');
                        initApp();
                    }
                }, 1000);
            }
        });
    </script>
</body>
</html>
